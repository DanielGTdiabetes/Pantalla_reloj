#!/usr/bin/env bash
set -euo pipefail

# Launcher robusto e idempotente para backend FastAPI
# Crea/usa venv, valida dependencias, garantiza directorios y lanza uvicorn

APP_ROOT="/opt/pantalla-reloj"
BACKEND_DIR="${APP_ROOT}/backend"
VENV_DIR="${BACKEND_DIR}/.venv"
VENV_PYTHON="${VENV_DIR}/bin/python"
VENV_PIP="${VENV_DIR}/bin/pip"
REQUIREMENTS_FILE="${BACKEND_DIR}/requirements.txt"
STATE_DIR="/var/lib/pantalla-reloj"
ICS_DIR="${STATE_DIR}/ics"
CONFIG_FILE="${STATE_DIR}/config.json"

# Log inicial
echo "[backend-launch] $(date -Is) start"
echo "[backend-launch] CONFIG_PATH=${CONFIG_FILE}"

# Validar que el directorio backend existe
if [[ ! -d "$BACKEND_DIR" ]]; then
  echo "[backend-launch] ERROR: BACKEND_DIR no existe: $BACKEND_DIR" >&2
  exit 2
fi

# Crear/usar venv si no existe
if [[ ! -x "$VENV_PYTHON" ]]; then
  echo "[backend-launch] Creando venv en ${VENV_DIR}..."
  python3 -m venv "$VENV_DIR"
  if [[ ! -x "$VENV_PYTHON" ]]; then
    echo "[backend-launch] ERROR: No se pudo crear venv en ${VENV_DIR}" >&2
    exit 2
  fi
  echo "[backend-launch] venv creado"
fi

# Actualizar pip
echo "[backend-launch] Actualizando pip..."
"$VENV_PIP" install --upgrade pip wheel --quiet || {
  echo "[backend-launch] WARN: No se pudo actualizar pip, continuando..." >&2
}

# Instalar dependencias con retry x2
if [[ -f "$REQUIREMENTS_FILE" ]]; then
  echo "[backend-launch] Instalando dependencias desde ${REQUIREMENTS_FILE}..."
  INSTALL_ATTEMPT=0
  MAX_ATTEMPTS=2
  INSTALL_SUCCESS=0
  
  while [[ $INSTALL_ATTEMPT -lt $MAX_ATTEMPTS ]]; do
    INSTALL_ATTEMPT=$((INSTALL_ATTEMPT + 1))
    echo "[backend-launch] Intento ${INSTALL_ATTEMPT}/${MAX_ATTEMPTS}..."
    
    if "$VENV_PIP" install -r "$REQUIREMENTS_FILE" --quiet; then
      INSTALL_SUCCESS=1
      echo "[backend-launch] Dependencias instaladas correctamente"
      break
    else
      if [[ $INSTALL_ATTEMPT -lt $MAX_ATTEMPTS ]]; then
        echo "[backend-launch] WARN: Instalación falló, reintentando en 2s..." >&2
        sleep 2
      else
        echo "[backend-launch] ERROR: No se pudieron instalar dependencias tras ${MAX_ATTEMPTS} intentos" >&2
      fi
    fi
  done
  
  if [[ $INSTALL_SUCCESS -eq 0 ]]; then
    exit 3
  fi
else
  echo "[backend-launch] WARN: No se encontró ${REQUIREMENTS_FILE}" >&2
fi

# Pre-flight check: validar imports críticos
echo "[backend-launch] Validando imports críticos..."
cd "$APP_ROOT"
export PYTHONPATH="$APP_ROOT"

PREFLIGHT_ERROR=0
"$VENV_PYTHON" -c "import fastapi" 2>/dev/null || {
  echo "[backend-launch] ERROR: fastapi no importable" >&2
  PREFLIGHT_ERROR=1
}
"$VENV_PYTHON" -c "import uvicorn" 2>/dev/null || {
  echo "[backend-launch] ERROR: uvicorn no importable" >&2
  PREFLIGHT_ERROR=1
}
"$VENV_PYTHON" -c "import multipart" 2>/dev/null || {
  echo "[backend-launch] ERROR: python-multipart no importable" >&2
  PREFLIGHT_ERROR=1
}
"$VENV_PYTHON" -c "import icalendar" 2>/dev/null || {
  echo "[backend-launch] ERROR: icalendar no importable" >&2
  PREFLIGHT_ERROR=1
}
"$VENV_PYTHON" -c "import backend.main" 2>&1 || {
  echo "[backend-launch] ERROR: backend.main no importable" >&2
  echo "[backend-launch] Intentando mostrar el error completo:" >&2
  "$VENV_PYTHON" -c "import backend.main" 2>&1 || true
  PREFLIGHT_ERROR=1
}

if [[ $PREFLIGHT_ERROR -eq 1 ]]; then
  echo "[backend-launch] ERROR: Pre-flight check falló. Reinstala dependencias." >&2
  exit 4
fi

echo "[backend-launch] Pre-flight check OK"

# Garantizar directorios de datos
# StateDirectory ya crea /var/lib/pantalla-reloj con permisos correctos
# Aseguramos permisos adicionales si es necesario

# Asegurar directorio ics con permisos 0700
# Nota: systemd StateDirectory crea /var/lib/pantalla-reloj con owner=%i y 0755
# Necesitamos crear /var/lib/pantalla-reloj/ics con 0700
echo "[backend-launch] Garantizando directorios de datos..."
if [[ ! -d "$ICS_DIR" ]]; then
  install -d -m 0700 "$ICS_DIR" 2>/dev/null || {
    echo "[backend-launch] WARN: No se pudo crear ${ICS_DIR} con 0700" >&2
  }
fi

# Lanzar uvicorn
# Nota: Intentamos usar uvloop y httptools si están disponibles
# Si no, usamos stdlib (por defecto de uvicorn[standard])
PORT="${PORT:-8081}"
echo "[backend-launch] Iniciando uvicorn en 127.0.0.1:${PORT}..."

# Verificar si uvloop y httptools están disponibles
HAS_UVLOOP=0
HAS_HTTPTOOLS=0
"$VENV_PYTHON" -c "import uvloop" 2>/dev/null && HAS_UVLOOP=1 || true
"$VENV_PYTHON" -c "import httptools" 2>/dev/null && HAS_HTTPTOOLS=1 || true

# Construir comando uvicorn
UVICORN_ARGS=(
  "backend.main:app"
  "--host" "127.0.0.1"
  "--port" "$PORT"
)

if [[ $HAS_UVLOOP -eq 1 ]]; then
  UVICORN_ARGS+=("--loop" "uvloop")
fi

if [[ $HAS_HTTPTOOLS -eq 1 ]]; then
  UVICORN_ARGS+=("--http" "httptools")
fi

exec "$VENV_PYTHON" -m uvicorn "${UVICORN_ARGS[@]}"


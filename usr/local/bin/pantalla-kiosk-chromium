#!/usr/bin/env bash
set -euo pipefail

log() {
  printf '[pantalla-kiosk-chromium] %s\n' "$*"
}

USER_NAME="${KIOSK_USER:-${USER:-$(id -un)}}"
CLASS_NAME="pantalla-kiosk"
PKILL_PATTERN="chromium.*--class=${CLASS_NAME}"

if command -v pkill >/dev/null 2>&1; then
  pkill -9 -u "$USER_NAME" -f "$PKILL_PATTERN" >/dev/null 2>&1 || true
fi

STATE_DIR="${STATE_DIR:-/var/lib/pantalla-reloj/state/chromium}"
CACHE_DIR="${CACHE_DIR:-/var/lib/pantalla-reloj/cache/chromium}"

mkdir -p "$STATE_DIR" "$CACHE_DIR"
chown "$USER_NAME:$USER_NAME" "$STATE_DIR" "$CACHE_DIR" 2>/dev/null || true

CHROME_BIN="${CHROME_BIN:-${CHROMIUM_BIN_OVERRIDE:-}}"
if [[ -z "$CHROME_BIN" ]]; then
  SNAP_CANDIDATE="/snap/chromium/current/usr/lib/chromium-browser/chrome"
  if [[ -x "$SNAP_CANDIDATE" ]]; then
    CHROME_BIN="$(readlink -f "$SNAP_CANDIDATE" 2>/dev/null || printf '%s' "$SNAP_CANDIDATE")"
  fi
fi

if [[ -z "$CHROME_BIN" ]]; then
  for candidate in chromium-browser chromium /snap/bin/chromium; do
    if command -v "$candidate" >/dev/null 2>&1; then
      CHROME_BIN="$(command -v "$candidate")"
      break
    fi
  done
fi

if [[ -z "$CHROME_BIN" || ! -x "$CHROME_BIN" ]]; then
  log "ERROR: No se encontr√≥ un binario de Chromium disponible"
  exit 1
fi

URL="${KIOSK_URL:-http://127.0.0.1}"
SCALE="${CHROMIUM_SCALE:-0.58}"

log "Usando binario: ${CHROME_BIN}"
log "Perfil: ${STATE_DIR}"
log "Cache: ${CACHE_DIR}"
log "URL: ${URL}"
log "Escala: ${SCALE}"

exec "$CHROME_BIN" \
  --class="${CLASS_NAME}" \
  --kiosk --start-fullscreen \
  --app="${URL}" \
  --no-first-run --no-default-browser-check \
  --disable-translate --disable-infobars \
  --disable-session-crashed-bubble --noerrdialogs \
  --disable-features=InfiniteSessionRestore,Translate,HardwareMediaKeyHandling,CalculateNativeWinOcclusion \
  --hide-scrollbars --overscroll-history-navigation=0 \
  --password-store=basic \
  --test-type \
  --ozone-platform=x11 \
  --disable-gpu \
  --force-device-scale-factor="${SCALE}" \
  --disk-cache-dir="${CACHE_DIR}" \
  --user-data-dir="${STATE_DIR}"

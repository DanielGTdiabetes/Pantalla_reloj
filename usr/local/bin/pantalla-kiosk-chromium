#!/usr/bin/env bash
set -euo pipefail

DEFAULT_ORIGIN="http://127.0.0.1"
DEFAULT_URL="${DEFAULT_ORIGIN}/"

log() {
  printf '[pantalla-kiosk-chromium] %s\n' "$*" >&2
}

list_matching_windows() {
  local patterns="$1"
  if ! command -v wmctrl >/dev/null 2>&1; then
    return 0
  fi
  local display="${DISPLAY:-:0}"
  local auth="${XAUTHORITY:-}"
  DISPLAY="$display" XAUTHORITY="$auth" wmctrl -lx 2>/dev/null | awk -v pat="$patterns" '$3 ~ pat {print $1}'
}

close_existing_windows() {
  local patterns='pantalla-kiosk|chrome.chromium|chromium-browser.Chromium-browser|chromium.Chromium'
  if ! command -v wmctrl >/dev/null 2>&1; then
    log "wmctrl no disponible: se omite limpieza previa de ventanas"
    return
  fi
  local -a ids
  mapfile -t ids < <(list_matching_windows "$patterns")
  if ((${#ids[@]} == 0)); then
    return
  fi
  log "cerrando ${#ids[@]} ventanas Chromium residuales"
  local display="${DISPLAY:-:0}"
  local auth="${XAUTHORITY:-}"
  for wid in "${ids[@]}"; do
    [[ -n "$wid" ]] || continue
    DISPLAY="$display" XAUTHORITY="$auth" wmctrl -ic "$wid" || true
  done
  sleep 0.3
}

cleanup_profile_artifacts() {
  local profile_dir="$1"
  local cache_dir="$2"
  local -a singleton_patterns=(SingletonLock SingletonCookie SingletonSocket)
  local base
  for base in "$profile_dir" "$cache_dir"; do
    [[ -d "$base" ]] || continue
    # Eliminar archivos de bloqueo singleton
    find "$base" -maxdepth 2 -type f \( -name "${singleton_patterns[0]}" -o -name "${singleton_patterns[1]}" -o -name "${singleton_patterns[2]}" \) -delete 2>/dev/null || true
    # Eliminar archivos LOCK
    local -a locks=()
    mapfile -t locks < <(find "$base" -maxdepth 3 -type f -name 'LOCK' -print 2>/dev/null)
    if ((${#locks[@]} > 0)); then
      local lock
      for lock in "${locks[@]}"; do
        rm -f "$lock"
      done
      log "eliminados ${#locks[@]} LOCK residuales en ${base}"
    fi
    # Asegurar permisos correctos del directorio
    if [[ -d "$base" ]]; then
      chown -R "$(id -u):$(id -g)" "$base" 2>/dev/null || true
      chmod -R u+rwX "$base" 2>/dev/null || true
    fi
  done
}

wait_for_backend() {
  local attempts="${KIOSK_WAIT_ATTEMPTS:-5}"
  local delay="${KIOSK_WAIT_DELAY_SEC:-2}"
  local endpoint="${KIOSK_HEALTHCHECK_URL:-${DEFAULT_ORIGIN%/}/api/config}"
  local attempt=1

  while (( attempt <= attempts )); do
    if curl -sf --max-time 4 "$endpoint" >/dev/null 2>&1; then
      log "backend disponible (intento ${attempt}/${attempts}): ${endpoint}"
      return 0
    fi
    log "backend aún no responde (intento ${attempt}/${attempts}) en ${endpoint}"
    sleep "$delay"
    attempt=$((attempt + 1))
  done

  log "WARN: backend sigue sin responder tras ${attempts} intentos: ${endpoint}"
  return 1
}

resolve_url() {
  local candidate="$1"
  if [[ -z "$candidate" ]]; then
    candidate="$DEFAULT_URL"
  fi
  if [[ "$candidate" == /* ]]; then
    candidate="${DEFAULT_ORIGIN%/}${candidate}"
  fi
  if [[ "$candidate" != http://* && "$candidate" != https://* ]]; then
    candidate="${candidate%/}"
    candidate="${DEFAULT_ORIGIN%/}/${candidate}"
  fi
  printf '%s\n' "$candidate"
}

prepare_dirs() {
  local profile_dir="$1" cache_dir="$2"
  install -d -m 0700 "$profile_dir"
  install -d -m 0700 "$cache_dir"
}

launch_chromium() {
  local use_swiftshader="$1"
  local chromium_bin="$2"
  local url="$3"
  local profile_dir="$4"
  local cache_dir="$5"

  local -a args
  args=(
    "$chromium_bin"
    --class=pantalla-kiosk
    --kiosk
    --start-fullscreen
    "--app=${url}"
    --no-first-run
    --no-default-browser-check
    --disable-translate
    --disable-infobars
    --disable-session-crashed-bubble
    --noerrdialogs
    --disable-background-networking
    --disable-sync
    --metrics-recording-only
    --disable-component-update
    --disable-features=InfiniteSessionRestore,Translate,AutofillServerCommunication,CalculateNativeWinOcclusion,SendTabToSelf,ProductNotifications,InterestFeedContentSuggestions,OptimizationHints,UseChromeLocationServices,HardwareMediaKeyHandling
    --disable-renderer-backgrounding
    --disable-background-timer-throttling
    --disable-backgrounding-occluded-windows
    --hide-scrollbars
    --overscroll-history-navigation=0
    --password-store=basic
    --test-type
    --ozone-platform=x11
    --ignore-gpu-blocklist
    --enable-webgl
    --enable-unsafe-swiftshader
    --use-gl=angle
    --use-angle=swiftshader
    "--disk-cache-dir=${cache_dir}"
    "--user-data-dir=${profile_dir}"
  )

  if [[ -n "${CHROMIUM_SCALE:-}" ]]; then
    args+=("--force-device-scale-factor=${CHROMIUM_SCALE}")
  fi

  if [[ "${PANTALLA_CHROMIUM_VERBOSE:-0}" == "1" ]]; then
    args+=(--enable-logging=stderr --v=1)
  else
    args+=(--enable-logging=stderr --log-level=1)
  fi

  # SwiftShader siempre habilitado para evitar problemas de GPU
  log "swiftshader habilitado para esta ejecución (--enable-unsafe-swiftshader, --use-gl=angle, --use-angle=swiftshader)"

  log "launch: ${args[*]}"
  log "url: ${url}"

  local log_dir="/var/log/pantalla"
  install -d -m 0755 "$log_dir"
  local persistent_log="${log_dir}/browser-kiosk.log"
  touch "$persistent_log"
  chmod 0644 "$persistent_log" 2>/dev/null || true
  if [[ -s "$persistent_log" ]]; then
    tail -n 4000 "$persistent_log" >"${persistent_log}.tmp" 2>/dev/null && mv "${persistent_log}.tmp" "$persistent_log"
  fi

  local log_file
  log_file="$(mktemp -p /tmp pantalla-chromium.XXXXXX.log)"
  if [[ -z "$log_file" ]]; then
    log "no se pudo crear archivo temporal en /tmp"
    log_file="/tmp/pantalla-chromium.log"
  fi
  log "stderr se registrará en ${log_file} y ${persistent_log}"

  "${args[@]}" 2> >(tee -a "$log_file" | tee -a "$persistent_log" >&2)
  local status=$?

  local fallback=0
  if (( use_swiftshader == 0 )); then
    if (( status != 0 )); then
      fallback=1
    else
      if grep -Eq \
        'Automatic fallback to software WebGL has been deprecated|GPU process isn'"'"'t usable|GpuProcessHostUIShim: The GPU process has crashed|GpuProcessHostUIShim:|GpuChannelHost|ERROR:gpu_init' \
        "$log_file"; then
        fallback=1
      fi
    fi
  fi

  if (( fallback )); then
    return 99
  fi

  return $status
}

main() {
  # Validar que XAUTHORITY existe y es legible
  if [[ -z "${XAUTHORITY:-}" ]]; then
    log "ERROR: XAUTHORITY no está definido"
    exit 1
  fi
  
  if [[ ! -r "$XAUTHORITY" ]]; then
    log "ERROR: XAUTHORITY no es legible: $XAUTHORITY"
    exit 1
  fi
  
  # Validar que DISPLAY está configurado
  if [[ -z "${DISPLAY:-}" ]]; then
    log "ERROR: DISPLAY no está definido"
    exit 1
  fi
  
  # Validar que el servidor X está accesible
  if ! xset q >/dev/null 2>&1; then
    log "ERROR: No se puede acceder al servidor X en $DISPLAY"
    log "ERROR: Verifica que pantalla-xorg@ está ejecutándose"
    exit 1
  fi

  wait_for_backend || true
  
  local chromium_bin="/usr/local/bin/chromium-kiosk-bin"
  if [[ ! -x "$chromium_bin" ]]; then
    log "ERROR: no se encontró el wrapper chromium-kiosk-bin en ${chromium_bin}"
    log "ERROR: verifica la instalación de Google Chrome y del wrapper en /usr/local/bin"
    exit 1
  fi

  if ! file "$chromium_bin" 2>/dev/null | grep -qE '(ELF|executable|binary)'; then
    log "ERROR: ${chromium_bin} no es un binario ejecutable válido"
    exit 1
  fi

  local raw_url
  raw_url="${KIOSK_URL:-${1:-}}"
  local target_url
  target_url="$(resolve_url "$raw_url")"

  local base_dir profile_dir cache_dir
  # Usar directorios estándar XDG (no Snap)
  profile_dir="${CHROMIUM_USER_DATA_DIR:-${HOME}/.local/share/pantalla-reloj/chromium}"
  cache_dir="${CHROMIUM_CACHE_DIR:-${HOME}/.cache/pantalla-reloj/chromium}"

  prepare_dirs "$profile_dir" "$cache_dir"
  cleanup_profile_artifacts "$profile_dir" "$cache_dir"

  if [[ -z "${DBUS_SESSION_BUS_ADDRESS:-}" ]]; then
    export DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/$(id -u)/bus"
  fi
  export GTK_USE_PORTAL=0
  export GIO_USE_PORTALS=0

  log "chromium_bin: ${chromium_bin}"
  log "user_data_dir: ${profile_dir}"
  log "cache_dir: ${cache_dir}"
  log "url: ${target_url}"

  if [[ "${PANTALLA_CHROMIUM_VERBOSE:-0}" == "1" ]]; then
    log "Chromium se inicia en modo verbose (--v=1)"
  fi

  close_existing_windows

  # SwiftShader siempre habilitado para evitar problemas de GPU (flags en args base)
  if launch_chromium 1 "$chromium_bin" "$target_url" "$profile_dir" "$cache_dir"; then
    exit 0
  fi

  local status=$?
  exit $status
}

main "$@"

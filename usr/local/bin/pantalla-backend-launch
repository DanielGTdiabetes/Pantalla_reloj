#!/usr/bin/env bash
set -euo pipefail
LOG=/tmp/backend-launch.log
exec >>"$LOG" 2>&1
echo "[backend] $(date -Is) start"

APP_DIR="/opt/pantalla-reloj/backend"
PY="$APP_DIR/.venv/bin/python"

if [[ ! -x "$PY" ]]; then
  echo "[backend] python no encontrado en $PY" >&2
  exit 1
fi

require_dir() {
  local dir="$1"
  if [[ ! -d "$dir" ]]; then
    echo "[backend] missing required directory $dir" >&2
    echo "[backend] please provision it via the installer or system setup" >&2
    exit 4
  fi
  if [[ ! -w "$dir" ]]; then
    echo "[backend] cannot write to $dir as $(id -un)" >&2
    exit 5
  fi
}

require_dir /var/log/pantalla
require_dir /var/lib/pantalla

cd "$APP_DIR"
export PYTHONPATH="$APP_DIR"

"$PY" - <<'PYCODE'
import importlib, sys
try:
    m = importlib.import_module("backend.main")
    print("[backend] import OK:", m.__name__)
except Exception as e:
    print("[backend] import FAIL:", repr(e))
    sys.exit(3)
PYCODE

exec "$PY" -m uvicorn backend.main:app \
  --host 127.0.0.1 --port 8081 \
  --proxy-headers --timeout-keep-alive 30

#!/usr/bin/env bash
set -euo pipefail
LOG=/tmp/backend-launch.log
exec >>"$LOG" 2>&1
echo "[backend] $(date -Is) start"

APP_DIR="/opt/pantalla-reloj/backend"
PY="$APP_DIR/.venv/bin/python"

if [[ ! -d "$APP_DIR" ]]; then
  echo "[backend] ERROR: APP_DIR no existe: $APP_DIR" >&2
  exit 2
fi

if [[ ! -x "$PY" ]]; then
  echo "[backend] ERROR: venv no existe: $PY" >&2
  exit 2
fi

cd "$APP_DIR"
export PYTHONPATH="$APP_DIR"

"$PY" - <<'PYCODE'
import importlib, sys
try:
    m = importlib.import_module("backend.main")
    print("[backend] import OK:", m.__name__)
except Exception as e:
    print("[backend] import FAIL:", repr(e))
    sys.exit(3)
PYCODE

exec "$PY" -m uvicorn backend.main:app \
  --host 127.0.0.1 --port 8081 \
  --proxy-headers --timeout-keep-alive 30

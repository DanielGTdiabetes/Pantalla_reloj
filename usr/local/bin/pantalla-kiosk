#!/usr/bin/env bash
set -euxo pipefail

URL="${1:-http://127.0.0.1}"
LOG=/tmp/kiosk-launch.log
ERR=/tmp/browser.err

touch "$LOG" "$ERR"
exec >>"$LOG"
exec 2>&1

: "${DISPLAY:=:0}"
: "${XAUTHORITY:?XAUTHORITY must be set}"
: "${XDG_RUNTIME_DIR:=/run/user/1000}"

STATE_DIR=/var/lib/pantalla-reloj/state
LOCK="$STATE_DIR/kiosk.lock"
OWNER="${KIOSK_USER:-${USER:-$(id -un)}}"

install -d -m 0755 "$STATE_DIR"
chown -R "$OWNER:$OWNER" "$STATE_DIR" || true

echo "[kiosk] $(date -Is) start user=$(id -un) DISPLAY=$DISPLAY XAUTHORITY=$XAUTHORITY URL=$URL"

# única instancia mediante lockfile
exec 9>"$LOCK"
if ! flock -n 9; then
  echo "[kiosk] lock activo, no se lanza otra instancia"
  exit 0
fi

# evitar duplicar ventanas si ya corre epiphany en modo aplicación
if pgrep -fa 'epiphany-browser.*--application-mode' >/dev/null 2>&1; then
  echo "[kiosk] epiphany-browser ya en ejecución (modo aplicación)"
  exit 0
fi

echo "[kiosk] esperando X con /opt/pantalla/bin/wait-x.sh"
DISPLAY="$DISPLAY" XAUTHORITY="$XAUTHORITY" /opt/pantalla/bin/wait-x.sh

check_http() {
  local name="$1" url="$2"
  if curl -fsS -m 1 "$url" >/dev/null; then
    echo "[kiosk] $name OK $url"
  else
    echo "[kiosk] $name fallo $url"
  fi
}

check_http FRONT "$URL"
(check_http API "http://127.0.0.1:8081/healthz") &

# detectar navegadores disponibles
EPIPHANY_BIN=""
if command -v epiphany-browser >/dev/null 2>&1; then
  EPIPHANY_BIN="$(command -v epiphany-browser)"
fi

chromium_snap_logged=0
for candidate in chromium chromium-browser google-chrome-stable google-chrome; do
  if command -v "$candidate" >/dev/null 2>&1; then
    bin_path="$(command -v "$candidate")"
    resolved="$(readlink -f "$bin_path" 2>/dev/null || printf '%s' "$bin_path")"
    if [[ "$bin_path" == /snap/bin/* || "$resolved" == /snap/* ]]; then
      if [[ "$chromium_snap_logged" -eq 0 ]]; then
        echo "[kiosk] Chromium (snap) no soportado: confinamiento bloquea X11/XAUTHORITY"
        chromium_snap_logged=1
      fi
    fi
  fi
done

if [[ -z "$EPIPHANY_BIN" ]]; then
  echo "[kiosk] epiphany-browser no encontrado"
  exit 1
fi

export GIO_USE_PORTALS=0
export GTK_USE_PORTAL=0

echo "[kiosk] lanzando epiphany-browser: $EPIPHANY_BIN"

exec env -i \
  DISPLAY="$DISPLAY" \
  XAUTHORITY="$XAUTHORITY" \
  XDG_RUNTIME_DIR="$XDG_RUNTIME_DIR" \
  HOME="${HOME:-/home/$OWNER}" \
  PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" \
  GIO_USE_PORTALS="$GIO_USE_PORTALS" \
  GTK_USE_PORTAL="$GTK_USE_PORTAL" \
  "$EPIPHANY_BIN" --application-mode --incognito --new-window "$URL" 2>>"$ERR"

#!/usr/bin/env bash
set -euo pipefail

DEFAULT_ORIGIN="http://127.0.0.1"
DEFAULT_URL="${DEFAULT_ORIGIN}/"

log() {
  printf '[pantalla-kiosk] %s\n' "$*" >&2
}

resolve_url() {
  local candidate="$1"
  if [[ -z "$candidate" ]]; then
    candidate="$DEFAULT_URL"
  fi
  if [[ "$candidate" == /* ]]; then
    candidate="${DEFAULT_ORIGIN%/}${candidate}"
  fi
  if [[ "$candidate" != http://* && "$candidate" != https://* ]]; then
    candidate="${candidate%/}"
    candidate="${DEFAULT_ORIGIN%/}/${candidate}"
  fi
  printf '%s\n' "$candidate"
}

find_firefox() {
  local candidate resolved
  for candidate in firefox-esr firefox "$FIREFOX_BIN_OVERRIDE"; do
    [[ -z "$candidate" ]] && continue
    if command -v "$candidate" >/dev/null 2>&1; then
      resolved="$(command -v "$candidate")"
      printf '%s\n' "$resolved"
      return 0
    fi
  done
  return 1
}

prepare_profile() {
  local dir="$1"
  install -d -m 0700 "$dir"
}

kill_existing() {
  if command -v pkill >/dev/null 2>&1; then
    pkill -u "$(id -u)" -x firefox-esr >/dev/null 2>&1 || true
    pkill -u "$(id -u)" -x firefox >/dev/null 2>&1 || true
  fi
}

main() {
  : "${DISPLAY:=:0}"
  : "${XAUTHORITY:?XAUTHORITY must be set}"
  : "${XDG_RUNTIME_DIR:=/run/user/$(id -u)}"

  local raw_url
  raw_url="${1:-${KIOSK_URL:-}}"
  local target_url
  target_url="$(resolve_url "$raw_url")"

  local firefox
  if ! firefox="$(find_firefox)"; then
    log "ERROR: firefox-esr/firefox no disponible en PATH"
    exit 1
  fi

  local state_base profile_dir log_dir
  state_base="${PANTALLA_STATE_DIR:-/var/lib/pantalla-reloj/state}"
  profile_dir="${FIREFOX_PROFILE_DIR:-${state_base}/firefox-kiosk}"
  log_dir="${PANTALLA_KIOSK_LOG_DIR:-/var/log/pantalla}"

  prepare_profile "$profile_dir"
  install -d -m 0755 "$log_dir" >/dev/null 2>&1 || true

  kill_existing

  export MOZ_DISABLE_SAFE_MODE_DIALOG=1
  export MOZ_USE_XINPUT2=1
  export MOZ_LOG_FILE="${log_dir}/firefox-kiosk.log"
  export MOZ_CRASHREPORTER_DISABLE=1
  export GTK_USE_PORTAL="${GTK_USE_PORTAL:-0}"
  export GIO_USE_PORTALS="${GIO_USE_PORTALS:-0}"
  export GDK_BACKEND="${GDK_BACKEND:-x11}"

  local -a cmd
  cmd=("${firefox}" --kiosk --new-instance --profile "$profile_dir" --no-remote "$target_url")

  log "launch: ${cmd[*]}"
  log "url: ${target_url}"

  exec "${cmd[@]}"
}

main "$@"

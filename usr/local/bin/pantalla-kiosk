#!/usr/bin/env bash
set -euxo pipefail
URL="${1:-http://127.0.0.1}"
: "${DISPLAY:=:0}"
: "${XAUTHORITY:?XAUTHORITY must be set}"
: "${XDG_RUNTIME_DIR:=/run/user/1000}"

LOG=/tmp/kiosk-launch.log
exec >>"$LOG" 2>&1
echo "[kiosk] $(date -Is) start user=$(id -un) DISPLAY=$DISPLAY URL=$URL"

STATE_DIR=/var/lib/pantalla-reloj/state
PROFILE_DIR="$STATE_DIR/org.gnome.Epiphany.WebApp_PantallaReloj"
LOCK="$STATE_DIR/kiosk.lock"
OWNER="${KIOSK_USER:-${USER:-$(id -un)}}"

if ! install -d -m 0755 "$STATE_DIR" "$PROFILE_DIR" 2>/dev/null; then
  if [[ ! -d "$PROFILE_DIR" ]]; then
    echo "[kiosk] no se pudo preparar el perfil: $PROFILE_DIR" >&2
    exit 1
  fi
fi
chown -R "$OWNER:$OWNER" "$STATE_DIR" || true

exec 9>"$LOCK"
if ! flock -n 9; then
  echo "[kiosk] otro proceso en ejecuciÃ³n; saliendo"
  exit 0
fi

DISPLAY="$DISPLAY" XAUTHORITY="$XAUTHORITY" /opt/pantalla/bin/wait-x.sh

EPIPHANY_BIN="$(command -v epiphany-browser || true)"
if [[ -z "$EPIPHANY_BIN" ]]; then
  echo "[kiosk] epiphany-browser no encontrado" >&2
  exit 1
fi

export GIO_USE_PORTALS=0
export GTK_USE_PORTAL=0

exec env -i DISPLAY="$DISPLAY" XAUTHORITY="$XAUTHORITY" XDG_RUNTIME_DIR="$XDG_RUNTIME_DIR" \
  HOME="/home/$OWNER" PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" \
  GIO_USE_PORTALS=0 GTK_USE_PORTAL=0 \
  "$EPIPHANY_BIN" --application-mode --profile="$PROFILE_DIR" --new-window "$URL"

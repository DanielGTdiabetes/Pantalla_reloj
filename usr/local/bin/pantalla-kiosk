#!/usr/bin/env bash
set -euo pipefail

DEFAULT_ORIGIN="http://127.0.0.1"
DEFAULT_URL="${DEFAULT_ORIGIN}/"
DEFAULT_STATE_DIR="/var/lib/pantalla-reloj/state"
DEFAULT_LOG_DIR="/var/log/pantalla"

log() {
  printf '[pantalla-kiosk] %s\n' "$*" >&2
}

resolve_url() {
  local candidate="$1"
  if [[ -z "$candidate" ]]; then
    candidate="$DEFAULT_URL"
  fi
  if [[ "$candidate" == /* ]]; then
    candidate="${DEFAULT_ORIGIN%/}${candidate}"
  fi
  if [[ "$candidate" != http://* && "$candidate" != https://* ]]; then
    candidate="${candidate%/}"
    candidate="${DEFAULT_ORIGIN%/}/${candidate}"
  fi
  printf '%s\n' "$candidate"
}

resolve_binary() {
  local candidate="$1"
  if [[ -z "$candidate" ]]; then
    return 1
  fi
  if [[ "$candidate" == */* ]]; then
    if [[ -x "$candidate" ]]; then
      printf '%s\n' "$candidate"
      return 0
    fi
    return 1
  fi
  if command -v "$candidate" >/dev/null 2>&1; then
    printf '%s\n' "$(command -v "$candidate")"
    return 0
  fi
  return 1
}

find_chromium() {
  local override
  override="${CHROME_BIN_OVERRIDE:-${CHROMIUM_BIN_OVERRIDE:-}}"
  if [[ -n "$override" ]]; then
    if resolved_bin="$(resolve_binary "$override" 2>/dev/null)"; then
      printf '%s\n' "$resolved_bin"
      return 0
    fi
    log "WARN: CHROME_BIN_OVERRIDE inválido (${override})"
  fi

  # Priorizar binarios normales de Chromium (sin Snap)
  local -a candidates=(
    /usr/local/bin/chromium-kiosk-bin
    google-chrome-stable
    google-chrome
    chromium-browser
    chromium
    chromium-browser-stable
  )
  local candidate resolved
  for candidate in "${candidates[@]}"; do
    if resolved="$(resolve_binary "$candidate" 2>/dev/null)"; then
      if [[ "$resolved" == "/usr/bin/chromium-browser" ]]; then
        log "INFO: Ignorando shim de chromium-browser en ${resolved}"
        continue
      fi
      # Evitar Snap si es posible
      if [[ "$resolved" != *"/snap/"* ]]; then
        printf '%s\n' "$resolved"
        return 0
      fi
    fi
  done

  # Fallback a Snap solo si no se encuentra ninguna alternativa
  local snap_candidate="/snap/chromium/current/usr/lib/chromium-browser/chrome"
  if [[ -x "$snap_candidate" ]]; then
    log "WARN: Usando Chromium desde Snap (no recomendado, instala Chromium normal)" >&2
    printf '%s\n' "$snap_candidate"
    return 0
  fi
  
  if [[ -x /snap/bin/chromium ]]; then
    log "WARN: Usando Chromium desde Snap (no recomendado, instala Chromium normal)" >&2
    printf '%s\n' "/snap/bin/chromium"
    return 0
  fi

  return 1
}

find_firefox() {
  local override
  override="${FIREFOX_BIN_OVERRIDE:-}"
  if [[ -n "$override" ]]; then
    if resolve_binary "$override"; then
      return 0
    fi
    log "WARN: FIREFOX_BIN_OVERRIDE inválido (${override})"
  fi

  local -a candidates=(firefox firefox-esr)
  local candidate
  for candidate in "${candidates[@]}"; do
    if resolve_binary "$candidate"; then
      return 0
    fi
  done

  return 1
}

prepare_dir() {
  local dir="$1"
  install -d -m 0700 "$dir"
  
  # Validar permisos del directorio antes de continuar
  if [[ -d "$dir" ]]; then
    local owner perms
    owner="$(stat -c '%U:%G' "$dir" 2>/dev/null || echo "")"
    perms="$(stat -c '%a' "$dir" 2>/dev/null || echo "")"
    local expected_owner="$(id -un):$(id -gn)"
    
    if [[ "$owner" != "$expected_owner" ]] || [[ "$perms" != "700" ]]; then
      log "WARN: Permisos incorrectos en $dir (owner=$owner, perms=$perms), corrigiendo..."
      chown -R "$(id -un):$(id -gn)" "$dir" 2>/dev/null || true
      chmod -R 700 "$dir" 2>/dev/null || true
      log "Permisos corregidos en $dir"
    fi
  fi
}

prepare_log_dir() {
  local dir="$1"
  install -d -m 0755 "$dir" >/dev/null 2>&1 || true
}

kill_existing() {
  command -v pkill >/dev/null 2>&1 || return 0
  local -a names=(
    chromium
    chromium-browser
    chrome
    google-chrome
    google-chrome-stable
    firefox
    firefox-esr
  )
  local name
  for name in "${names[@]}"; do
    pkill -u "$(id -u)" -x "$name" >/dev/null 2>&1 || true
  done
}

launch_chromium() {
  local binary="$1" url="$2" profile_dir="$3" log_file="$4"
  local -a cmd
  cmd=(
    "$binary"
    --class=pantalla-kiosk
    --kiosk
    --no-first-run
    --no-default-browser-check
    --password-store=basic
    "--user-data-dir=${profile_dir}"
    "$url"
  )

  log "chromium_bin: ${binary}"
  log "profile_dir: ${profile_dir}"
  log "launch: ${cmd[*]}"
  log "url: ${url}"

  # Validar permisos del perfil antes de lanzar Chrome
  if [[ -d "$profile_dir" ]]; then
    local owner perms
    owner="$(stat -c '%U:%G' "$profile_dir" 2>/dev/null || echo "")"
    perms="$(stat -c '%a' "$profile_dir" 2>/dev/null || echo "")"
    local expected_owner="$(id -un):$(id -gn)"
    
    if [[ "$owner" != "$expected_owner" ]] || [[ "$perms" != "700" ]]; then
      log "WARN: Permisos incorrectos en perfil Chrome, corrigiendo..."
      chown -R "$(id -un):$(id -gn)" "$profile_dir" 2>/dev/null || true
      chmod -R 700 "$profile_dir" 2>/dev/null || true
      log "Permisos del perfil Chrome corregidos"
    fi
  fi

  # Intentar lanzar Chrome con relanzamiento si falla rápidamente (evita pantallazos negros)
  local quick_fail_threshold=2
  local start_time=$(date +%s)
  
  # Ejecutar Chrome en background para poder detectar si termina rápido
  "${cmd[@]}" >>"$log_file" 2>&1 &
  local chrome_pid=$!
  sleep "$quick_fail_threshold"
  
  # Verificar si Chrome sigue ejecutándose
  if ! kill -0 "$chrome_pid" 2>/dev/null; then
    # Chrome terminó, verificar si fue muy rápido (posible fallo puntual)
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    
    if [[ $duration -le $quick_fail_threshold ]]; then
      log "WARN: Chrome terminó en ${duration}s (posible fallo puntual), relanzando una vez..."
      sleep 1
      
      # Relanzar Chrome una vez más
      start_time=$(date +%s)
      "${cmd[@]}" >>"$log_file" 2>&1 &
      chrome_pid=$!
      sleep "$quick_fail_threshold"
      
      if ! kill -0 "$chrome_pid" 2>/dev/null; then
        end_time=$(date +%s)
        duration=$((end_time - start_time))
        if [[ $duration -le $quick_fail_threshold ]]; then
          log "ERROR: Chrome falló nuevamente tras ${duration}s, no se relanzará más"
          exit 1
        fi
      fi
    fi
  fi
  
  # Chrome está ejecutándose correctamente, esperar a que termine normalmente
  wait "$chrome_pid"
  exit $?
}

launch_firefox() {
  local binary="$1" url="$2" profile_dir="$3" log_file="$4"
  local -a cmd
  cmd=(
    "$binary"
    --kiosk
    --new-instance
    --profile "$profile_dir"
    --no-remote
    "$url"
  )

  export MOZ_DISABLE_SAFE_MODE_DIALOG=1
  export MOZ_USE_XINPUT2=1
  export MOZ_CRASHREPORTER_DISABLE=1

  log "firefox_bin: ${binary}"
  log "profile_dir: ${profile_dir}"
  log "launch: ${cmd[*]}"
  log "url: ${url}"

  if ! exec "${cmd[@]}" >>"$log_file" 2>&1; then
    log "ERROR: fallo al ejecutar Firefox (${binary})"
    exit 1
  fi
}

main() {
  : "${DISPLAY:=:0}"
  : "${XAUTHORITY:?XAUTHORITY must be set}"
  : "${XDG_RUNTIME_DIR:=/run/user/$(id -u)}"
  : "${DBUS_SESSION_BUS_ADDRESS:=unix:path=/run/user/$(id -u)/bus}"

  export GTK_USE_PORTAL="${GTK_USE_PORTAL:-0}"
  export GIO_USE_PORTALS="${GIO_USE_PORTALS:-0}"
  export GDK_BACKEND="${GDK_BACKEND:-x11}"

  local raw_url target_url
  raw_url="${1:-${KIOSK_URL:-}}"
  target_url="$(resolve_url "$raw_url")"

  local state_base
  state_base="${PANTALLA_STATE_DIR:-${DEFAULT_STATE_DIR}}"

  local chromium_profile firefox_profile
  chromium_profile="${CHROMIUM_PROFILE_DIR:-${state_base}/chromium-kiosk}"
  firefox_profile="${FIREFOX_PROFILE_DIR:-${state_base}/firefox-kiosk}"

  local log_dir log_file
  log_dir="${PANTALLA_KIOSK_LOG_DIR:-${DEFAULT_LOG_DIR}}"
  log_file="${log_dir}/browser-kiosk.log"

  install -d -m 0755 "$state_base"
  prepare_dir "$chromium_profile"
  prepare_dir "$firefox_profile"
  prepare_log_dir "$log_dir"

  kill_existing

  local browser
  if browser="$(find_chromium)"; then
    launch_chromium "$browser" "$target_url" "$chromium_profile" "$log_file"
  fi

  if browser="$(find_firefox)"; then
    launch_firefox "$browser" "$target_url" "$firefox_profile" "$log_file"
  fi

  log "ERROR: no se encontró un navegador compatible (Chromium/Firefox)"
  exit 1
}

main "$@"

#!/usr/bin/env bash
set -euxo pipefail
URL="${1:-http://127.0.0.1}"
: "${DISPLAY:=:0}"
: "${XAUTHORITY:?XAUTHORITY must be set}"
: "${XDG_RUNTIME_DIR:=/run/user/1000}"

LOG=/tmp/kiosk-launch.log
exec >>"$LOG" 2>&1
echo "[kiosk] $(date -Is) start user=$(id -un) DISPLAY=$DISPLAY URL=$URL"

/opt/pantalla/bin/wait-x.sh

skip_snap() {
  local b="$1"; local r
  r="$(readlink -f "$b" 2>/dev/null || echo "$b")"
  [[ "$b" == /snap/bin/* || "$r" == /snap/* ]]
}

EPIPHANY_BIN="$(command -v epiphany-browser || true)"
if [[ -z "$EPIPHANY_BIN" ]]; then
  echo "[kiosk] epiphany-browser no encontrado" >&2
  exit 1
fi
if skip_snap "$EPIPHANY_BIN"; then
  echo "[kiosk] epiphany-browser proviene de snap y no se puede usar" >&2
  exit 1
fi

curl -fsS -m 1 "$URL" >/dev/null && echo "[kiosk] FRONT OK $URL" || echo "[kiosk] FRONT FAIL $URL"
(check_http(){ curl -fsS -m 1 "$1" >/dev/null && echo "[kiosk] API OK $1" || echo "[kiosk] API FAIL $1"; }; check_http http://127.0.0.1:8081/healthz) &

PROFILE_DIR=/var/lib/pantalla-reloj/state/org.gnome.Epiphany.WebApp_PantallaReloj
install -d -m 0755 "$PROFILE_DIR"

export GIO_USE_PORTALS=0 GTK_USE_PORTAL=0
exec env -i DISPLAY="$DISPLAY" XAUTHORITY="$XAUTHORITY" XDG_RUNTIME_DIR="$XDG_RUNTIME_DIR" \
  HOME="/home/$(id -un)" PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" \
  GIO_USE_PORTALS=0 GTK_USE_PORTAL=0 \
  "$EPIPHANY_BIN" --application-mode --profile="$PROFILE_DIR" --new-window "$URL"

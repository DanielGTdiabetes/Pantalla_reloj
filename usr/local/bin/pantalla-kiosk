#!/usr/bin/env bash
set -euo pipefail

DEFAULT_ORIGIN="http://127.0.0.1"
DEFAULT_URL="${DEFAULT_ORIGIN}/"
DEFAULT_STATE_DIR="/var/lib/pantalla-reloj/state"
DEFAULT_LOG_DIR="/var/log/pantalla"

log() {
  printf '[pantalla-kiosk] %s\n' "$*" >&2
}

resolve_url() {
  local candidate="$1"
  if [[ -z "$candidate" ]]; then
    candidate="$DEFAULT_URL"
  fi
  if [[ "$candidate" == /* ]]; then
    candidate="${DEFAULT_ORIGIN%/}${candidate}"
  fi
  if [[ "$candidate" != http://* && "$candidate" != https://* ]]; then
    candidate="${candidate%/}"
    candidate="${DEFAULT_ORIGIN%/}/${candidate}"
  fi
  printf '%s\n' "$candidate"
}

resolve_binary() {
  local candidate="$1"
  if [[ -z "$candidate" ]]; then
    return 1
  fi
  if [[ "$candidate" == */* ]]; then
    if [[ -x "$candidate" ]]; then
      printf '%s\n' "$candidate"
      return 0
    fi
    return 1
  fi
  if command -v "$candidate" >/dev/null 2>&1; then
    printf '%s\n' "$(command -v "$candidate")"
    return 0
  fi
  return 1
}

find_chromium() {
  local override
  override="${CHROME_BIN_OVERRIDE:-${CHROMIUM_BIN_OVERRIDE:-}}"
  if [[ -n "$override" ]]; then
    if resolved_bin="$(resolve_binary "$override" 2>/dev/null)"; then
      printf '%s\n' "$resolved_bin"
      return 0
    fi
    log "WARN: CHROME_BIN_OVERRIDE inválido (${override})"
  fi

  # Priorizar binarios normales de Chromium (sin Snap)
  local -a candidates=(
    /usr/local/bin/chromium-kiosk-bin
    google-chrome-stable
    google-chrome
    chromium-browser
    chromium
    chromium-browser-stable
  )
  local candidate resolved
  for candidate in "${candidates[@]}"; do
    if resolved="$(resolve_binary "$candidate" 2>/dev/null)"; then
      if [[ "$resolved" == "/usr/bin/chromium-browser" ]]; then
        log "INFO: Ignorando shim de chromium-browser en ${resolved}"
        continue
      fi
      # Evitar Snap si es posible
      if [[ "$resolved" != *"/snap/"* ]]; then
        printf '%s\n' "$resolved"
        return 0
      fi
    fi
  done

  # Fallback a Snap solo si no se encuentra ninguna alternativa
  local snap_candidate="/snap/chromium/current/usr/lib/chromium-browser/chrome"
  if [[ -x "$snap_candidate" ]]; then
    log "WARN: Usando Chromium desde Snap (no recomendado, instala Chromium normal)" >&2
    printf '%s\n' "$snap_candidate"
    return 0
  fi
  
  if [[ -x /snap/bin/chromium ]]; then
    log "WARN: Usando Chromium desde Snap (no recomendado, instala Chromium normal)" >&2
    printf '%s\n' "/snap/bin/chromium"
    return 0
  fi

  return 1
}

find_firefox() {
  local override
  override="${FIREFOX_BIN_OVERRIDE:-}"
  if [[ -n "$override" ]]; then
    if resolve_binary "$override"; then
      return 0
    fi
    log "WARN: FIREFOX_BIN_OVERRIDE inválido (${override})"
  fi

  local -a candidates=(firefox firefox-esr)
  local candidate
  for candidate in "${candidates[@]}"; do
    if resolve_binary "$candidate"; then
      return 0
    fi
  done

  return 1
}

# Verificar que el directorio del perfil existe y es accesible
# NO crear ni modificar permisos aquí - eso se hace solo en scripts/install.sh
verify_profile_dir() {
  local dir="$1"
  local profile_name="$2"
  
  if [[ ! -d "$dir" ]]; then
    log "ERROR: El directorio del perfil ${profile_name} no existe: $dir"
    log "ERROR: Ejecuta scripts/install.sh para crear el perfil correctamente"
    exit 1
  fi
  
  # Verificar que es accesible (lectura)
  if [[ ! -r "$dir" ]] || [[ ! -x "$dir" ]]; then
    log "ERROR: El directorio del perfil ${profile_name} no es accesible: $dir"
    log "ERROR: Ejecuta scripts/install.sh para corregir los permisos"
    exit 1
  fi
  
  # Log informativo sobre el estado (sin modificar nada)
  local owner perms
  owner="$(stat -c '%U:%G' "$dir" 2>/dev/null || echo "unknown")"
  perms="$(stat -c '%a' "$dir" 2>/dev/null || echo "unknown")"
  log "Perfil ${profile_name}: $dir (owner=$owner, perms=$perms)"
}

prepare_log_dir() {
  local dir="$1"
  install -d -m 0755 "$dir" >/dev/null 2>&1 || true
}

kill_existing() {
  command -v pkill >/dev/null 2>&1 || return 0
  local -a names=(
    chromium
    chromium-browser
    chrome
    google-chrome
    google-chrome-stable
    firefox
    firefox-esr
  )
  local name
  for name in "${names[@]}"; do
    pkill -u "$(id -u)" -x "$name" >/dev/null 2>&1 || true
  done
}

wait_for_backend() {
  local max_attempts="${1:-60}"
  local attempt=0
  log "Esperando a que el backend esté listo (máx ${max_attempts}s)..."
  
  while [[ $attempt -lt $max_attempts ]]; do
    if curl -sf --max-time 2 http://127.0.0.1:8081/api/health >/dev/null 2>&1; then
      log "Backend listo en el intento $((attempt + 1))"
      return 0
    fi
    sleep 1
    attempt=$((attempt + 1))
  done
  
  log "WARN: Backend no responde después de ${max_attempts}s, continuando de todos modos..."
  return 1
}

wait_for_frontend() {
  local max_attempts="${1:-30}"
  local attempt=0
  log "Esperando a que el frontend esté listo (máx ${max_attempts}s)..."
  
  while [[ $attempt -lt $max_attempts ]]; do
    if curl -sf --max-time 2 http://127.0.0.1/ >/dev/null 2>&1; then
      log "Frontend listo en el intento $((attempt + 1))"
      return 0
    fi
    sleep 1
    attempt=$((attempt + 1))
  done
  
  log "WARN: Frontend no responde después de ${max_attempts}s, continuando de todos modos..."
  return 1
}

launch_chromium() {
  local binary="$1" url="$2" profile_dir="$3" log_file="$4"
  local -a cmd
  cmd=(
    "$binary"
    --class=pantalla-kiosk
    --kiosk
    --no-first-run
    --no-default-browser-check
    --password-store=basic
    "--user-data-dir=${profile_dir}"
    "$url"
  )

  log "chromium_bin: ${binary}"
  log "profile_dir: ${profile_dir}"
  log "launch: ${cmd[*]}"
  log "url: ${url}"

  # Verificar que el perfil existe (no modificar permisos aquí)
  verify_profile_dir "$profile_dir" "Chrome"

  # Esperar a que el backend y frontend estén listos antes de lanzar Chrome
  # Esto evita la pantalla negra al arrancar desde un estado "frío"
  wait_for_backend 60
  wait_for_frontend 30
  
  # Dar tiempo adicional para que todo se estabilice después de un arranque frío
  sleep 3

  # Intentar lanzar Chrome con relanzamiento si falla rápidamente (evita pantallazos negros)
  local quick_fail_threshold=3
  local max_retries=3
  local retry=0
  local start_time
  local chrome_pid
  
  while [[ $retry -lt $max_retries ]]; do
    start_time=$(date +%s)
    
    # Ejecutar Chrome en background para poder detectar si termina rápido
    "${cmd[@]}" >>"$log_file" 2>&1 &
    chrome_pid=$!
    sleep "$quick_fail_threshold"
    
    # Verificar si Chrome sigue ejecutándose
    if kill -0 "$chrome_pid" 2>/dev/null; then
      log "Chrome arrancó correctamente (PID: $chrome_pid)"
      break
    fi
    
    # Chrome terminó, verificar si fue muy rápido (posible fallo puntual)
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    
    retry=$((retry + 1))
    if [[ $retry -lt $max_retries ]]; then
      log "WARN: Chrome terminó en ${duration}s (intento $retry/$max_retries), reintentando en 2s..."
      sleep 2
    else
      log "ERROR: Chrome falló después de ${max_retries} intentos"
      exit 1
    fi
  done
  
  # Chrome está ejecutándose correctamente, esperar a que termine normalmente
  wait "$chrome_pid"
  exit $?
}

launch_firefox() {
  local binary="$1" url="$2" profile_dir="$3" log_file="$4"
  local -a cmd
  cmd=(
    "$binary"
    --kiosk
    --new-instance
    --profile "$profile_dir"
    --no-remote
    "$url"
  )

  export MOZ_DISABLE_SAFE_MODE_DIALOG=1
  export MOZ_USE_XINPUT2=1
  export MOZ_CRASHREPORTER_DISABLE=1

  log "firefox_bin: ${binary}"
  log "profile_dir: ${profile_dir}"
  log "launch: ${cmd[*]}"
  log "url: ${url}"

  if ! exec "${cmd[@]}" >>"$log_file" 2>&1; then
    log "ERROR: fallo al ejecutar Firefox (${binary})"
    exit 1
  fi
}

main() {
  : "${DISPLAY:=:0}"
  : "${XAUTHORITY:?XAUTHORITY must be set}"
  : "${XDG_RUNTIME_DIR:=/run/user/$(id -u)}"
  : "${DBUS_SESSION_BUS_ADDRESS:=unix:path=/run/user/$(id -u)/bus}"

  export GTK_USE_PORTAL="${GTK_USE_PORTAL:-0}"
  export GIO_USE_PORTALS="${GIO_USE_PORTALS:-0}"
  export GDK_BACKEND="${GDK_BACKEND:-x11}"

  local raw_url target_url
  raw_url="${1:-${KIOSK_URL:-}}"
  target_url="$(resolve_url "$raw_url")"

  local state_base
  state_base="${PANTALLA_STATE_DIR:-${DEFAULT_STATE_DIR}}"

  local chromium_profile firefox_profile
  chromium_profile="${CHROMIUM_PROFILE_DIR:-${state_base}/chromium-kiosk}"
  firefox_profile="${FIREFOX_PROFILE_DIR:-${state_base}/firefox-kiosk}"

  local log_dir log_file
  log_dir="${PANTALLA_KIOSK_LOG_DIR:-${DEFAULT_LOG_DIR}}"
  log_file="${log_dir}/browser-kiosk.log"

  # Verificar que los directorios base existen (solo crear logs, no perfiles)
  prepare_log_dir "$log_dir"
  
  # Verificar perfiles (NO crear ni modificar permisos - eso se hace en install.sh)
  verify_profile_dir "$chromium_profile" "Chrome"
  verify_profile_dir "$firefox_profile" "Firefox"

  kill_existing

  local browser
  if browser="$(find_chromium)"; then
    launch_chromium "$browser" "$target_url" "$chromium_profile" "$log_file"
  fi

  if browser="$(find_firefox)"; then
    launch_firefox "$browser" "$target_url" "$firefox_profile" "$log_file"
  fi

  log "ERROR: no se encontró un navegador compatible (Chromium/Firefox)"
  exit 1
}

main "$@"

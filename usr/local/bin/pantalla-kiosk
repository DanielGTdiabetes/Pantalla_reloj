#!/usr/bin/env bash
set -euo pipefail

DEFAULT_ORIGIN="http://127.0.0.1"
DEFAULT_URL="${DEFAULT_ORIGIN}/"
DEFAULT_STATE_DIR="/var/lib/pantalla-reloj/state"
DEFAULT_LOG_DIR="/var/log/pantalla"
PROFILE_DIR="/var/lib/pantalla-reloj/state/chromium-kiosk"

MAX_RETRIES="${CHROME_MAX_RETRIES:-10}"
SUCCESS_THRESHOLD="${CHROME_SUCCESS_THRESHOLD:-15}"
MAX_BACKOFF="${CHROME_MAX_BACKOFF:-15}"
EARLY_EXIT_THRESHOLD=10

LOG_DIR="/var/log/pantalla"
LOG_FILE="$LOG_DIR/browser-kiosk.log"

mkdir -p "$LOG_DIR"
touch "$LOG_FILE"
chown "$USER:$USER" "$LOG_FILE"
chmod 644 "$LOG_FILE"

timestamp() { date '+%Y-%m-%dT%H:%M:%S%z'; }
log() { local level="$1"; shift; printf '[%s] [pantalla-kiosk] [%s] %s\n' "$(timestamp)" "$level" "$*" >&2; }
log_info() { log INFO "$@"; }
log_warn() { log WARN "$@"; }
log_error() { log ERROR "$@"; }
wait_for_pid_exit() { local pid="$1"; while kill -0 "$pid" 2>/dev/null; do sleep 1; done; }

resolve_url() {
  local candidate="$1"
  if [[ -z "$candidate" ]]; then
    candidate="$DEFAULT_URL"
  fi
  if [[ "$candidate" == /* ]]; then
    candidate="${DEFAULT_ORIGIN%/}${candidate}"
  fi
  if [[ "$candidate" != http://* && "$candidate" != https://* ]]; then
    candidate="${candidate%/}"
    candidate="${DEFAULT_ORIGIN%/}/${candidate}"
  fi
  printf '%s\n' "$candidate"
}

resolve_binary() {
  local candidate="$1"
  if [[ -z "$candidate" ]]; then
    return 1
  fi
  if [[ "$candidate" == */* ]]; then
    if [[ -x "$candidate" ]]; then
      printf '%s\n' "$candidate"
      return 0
    fi
    return 1
  fi
  if command -v "$candidate" >/dev/null 2>&1; then
    printf '%s\n' "$(command -v "$candidate")"
    return 0
  fi
  return 1
}

find_chromium() {
  local override
  override="${CHROME_BIN_OVERRIDE:-${CHROMIUM_BIN_OVERRIDE:-}}"
  if [[ -n "$override" ]]; then
    if resolved_bin="$(resolve_binary "$override" 2>/dev/null)"; then
      printf '%s\n' "$resolved_bin"
      return 0
    fi
    log_warn "CHROME_BIN_OVERRIDE inválido (${override})"
  fi

  local -a candidates=(
    /usr/local/bin/chromium-kiosk-bin
    google-chrome-stable
    google-chrome
    chromium-browser
    chromium
    chromium-browser-stable
  )
  local candidate resolved
  for candidate in "${candidates[@]}"; do
    if resolved="$(resolve_binary "$candidate" 2>/dev/null)"; then
      if [[ "$resolved" == "/usr/bin/chromium-browser" ]]; then
        log_info "Ignorando shim de chromium-browser en ${resolved}"
        continue
      fi
      if [[ "$resolved" != *"/snap/"* ]]; then
        printf '%s\n' "$resolved"
        return 0
      fi
    fi
  done

  local snap_candidate="/snap/chromium/current/usr/lib/chromium-browser/chrome"
  if [[ -x "$snap_candidate" ]]; then
    log_warn "Usando Chromium desde Snap (no recomendado, instala Chromium normal)"
    printf '%s\n' "$snap_candidate"
    return 0
  fi

  if [[ -x /snap/bin/chromium ]]; then
    log_warn "Usando Chromium desde Snap (no recomendado, instala Chromium normal)"
    printf '%s\n' "/snap/bin/chromium"
    return 0
  fi

  return 1
}

find_firefox() {
  local override
  override="${FIREFOX_BIN_OVERRIDE:-}"
  if [[ -n "$override" ]]; then
    if resolve_binary "$override"; then
      return 0
    fi
    log_warn "FIREFOX_BIN_OVERRIDE inválido (${override})"
  fi

  local -a candidates=(firefox firefox-esr)
  local candidate
  for candidate in "${candidates[@]}"; do
    if resolve_binary "$candidate"; then
      return 0
    fi
  done

  return 1
}

verify_profile_dir() {
  local dir="$1" profile_name="$2"

  if [[ ! -d "$dir" ]]; then
    log_error "El directorio del perfil ${profile_name} no existe: $dir"
    log_error "Ejecuta scripts/install.sh para crear el perfil correctamente"
    exit 1
  fi

  if [[ ! -r "$dir" ]] || [[ ! -x "$dir" ]]; then
    log_error "El directorio del perfil ${profile_name} no es accesible: $dir"
    log_error "Ejecuta scripts/install.sh para corregir los permisos"
    exit 1
  fi

  local owner perms
  owner="$(stat -c '%U:%G' "$dir" 2>/dev/null || echo "unknown")"
  perms="$(stat -c '%a' "$dir" 2>/dev/null || echo "unknown")"
  if [[ "$owner" != "${USER}:${USER}" ]] || [[ "$perms" != "700" ]]; then
    log_warn "Perfil ${profile_name} con owner/perms inesperados (owner=$owner, perms=$perms, esperado=${USER}:${USER} 700)"
  else
    log_info "Perfil ${profile_name}: $dir (owner=$owner, perms=$perms)"
  fi
}

prepare_log_dir() {
  local dir="$1"
  install -d -m 0755 "$dir" >/dev/null 2>&1 || true
}

is_chrome_running_for_profile() {
  local profile_dir="$1"
  local pattern="--user-data-dir=${profile_dir}"
  if pgrep -u "$(id -u)" -f "chrome.*${pattern}" >/dev/null 2>&1; then
    return 0
  fi
  if pgrep -u "$(id -u)" -f "chromium.*${pattern}" >/dev/null 2>&1; then
    return 0
  fi
  return 1
}

find_kiosk_pid() {
  local profile_dir="$1"
  local run_user="${RUN_USER:-$(id -un)}"
  local -a patterns=(
    "/opt/google/chrome/chrome.*--class=pantalla-kiosk.*--kiosk.*--user-data-dir=${profile_dir}"
    "/opt/google/chrome/chrome.*--user-data-dir=${profile_dir}.*http://127.0.0.1/"
  )

  local pattern
  for pattern in "${patterns[@]}"; do
    mapfile -t kiosk_pids < <(pgrep -u "$run_user" -f "$pattern" 2>/dev/null | sort -n) || true
    if [[ ${#kiosk_pids[@]} -gt 0 ]]; then
      printf '%s\n' "${kiosk_pids[0]}"
      return 0
    fi
  done

  return 1
}

list_profile_locks() {
  local dir="$1"
  local -a locks=(SingletonLock SingletonCookie SingletonSocket)
  local existing=()
  local lock
  for lock in "${locks[@]}"; do
    if [[ -e "${dir}/${lock}" ]]; then
      existing+=("${dir}/${lock}")
    fi
  done
  printf '%s\n' "${existing[@]:-}"
}

cleanup_orphan_profile_locks() {
  local dir="$1"
  local running=0
  if is_chrome_running_for_profile "$dir"; then
    running=1
  fi

  local -a locks_to_remove
  mapfile -t locks_to_remove < <(list_profile_locks "$dir") || true

  if [[ ${#locks_to_remove[@]} -eq 0 ]]; then
    log_info "Perfil sin locks pendientes en ${dir}"
    return 0
  fi

  if [[ $running -eq 1 ]]; then
    log_info "Locks presentes en ${dir} pero Chrome sigue activo; no se tocan"
    return 1
  fi

  local removed=0
  local lock
  for lock in "${locks_to_remove[@]}"; do
    rm -f -- "$lock" || true
    log_warn "Lock huérfano eliminado: ${lock}"
    removed=1
  done
  if [[ $removed -eq 0 ]]; then
    log_info "No se eliminaron locks en ${dir}"
  fi
  return 0
}

print_chrome_logs() {
  local profile_dir="$1"
  local -a candidates=(
    "${profile_dir}/chrome_debug.log"
    "$HOME/.config/google-chrome/chrome_debug.log"
    "$HOME/.cache/google-chrome/chrome_debug.log"
  )

  local candidate printed=0
  for candidate in "${candidates[@]}"; do
    if [[ -f "$candidate" ]]; then
      log_info "Últimas líneas de ${candidate}:"
      tail -n 50 "$candidate" >&2 || true
      printed=1
      break
    fi
  done

  if [[ $printed -eq 0 ]]; then
    log_info "No se encontró chrome_debug.log para inspeccionar"
  fi
}

wait_for_backend() {
  local max_attempts="${1:-60}"
  local attempt=0
  log_info "Esperando a que el backend esté listo (máx ${max_attempts}s)..."

  while [[ $attempt -lt $max_attempts ]]; do
    if curl -sf --max-time 2 http://127.0.0.1:8081/api/health >/dev/null 2>&1; then
      log_info "Backend listo en el intento $((attempt + 1))"
      return 0
    fi
    sleep 1
    attempt=$((attempt + 1))
  done

  log_warn "Backend no responde después de ${max_attempts}s, continuando de todos modos..."
  return 1
}

wait_for_frontend() {
  local max_attempts="${1:-30}"
  local attempt=0
  log_info "Esperando a que el frontend esté listo (máx ${max_attempts}s)..."

  while [[ $attempt -lt $max_attempts ]]; do
    if curl -sf --max-time 2 http://127.0.0.1/ >/dev/null 2>&1; then
      log_info "Frontend listo en el intento $((attempt + 1))"
      return 0
    fi
    sleep 1
    attempt=$((attempt + 1))
  done

  log_warn "Frontend no responde después de ${max_attempts}s, continuando de todos modos..."
  return 1
}

launch_chromium() {
  local binary="$1" url="$2" profile_dir="$3" log_file="$4"
  local -a cmd=(
    "$binary"
    --class=pantalla-kiosk
    --kiosk
    --no-first-run
    --no-default-browser-check
    --password-store=basic
    "--user-data-dir=${profile_dir}"
  )

  if [[ "${CHROME_DISABLE_GPU:-0}" == "1" ]]; then
    cmd+=(--disable-gpu --disable-software-rasterizer)
  fi
  if [[ -n "${CHROME_OZONE_PLATFORM:-}" ]]; then
    cmd+=("--ozone-platform=${CHROME_OZONE_PLATFORM}")
  fi
  if [[ "${CHROME_NO_SANDBOX:-0}" == "1" ]]; then
    log_warn "CHROME_NO_SANDBOX=1 habilitado; --no-sandbox reduce la seguridad"
    cmd+=(--no-sandbox)
  fi
  if [[ "${CHROME_DISABLE_CRASH_REPORTER:-0}" == "1" ]]; then
    cmd+=(--disable-crash-reporter --disable-breakpad)
  fi
  if [[ -n "${CHROME_EXTRA_FLAGS:-}" ]]; then
    # shellcheck disable=SC2206
    local extra_flags=( ${CHROME_EXTRA_FLAGS} )
    cmd+=("${extra_flags[@]}")
  fi
  cmd+=("${url}")

  log_info "chromium_bin: ${binary}"
  log_info "profile_dir: ${profile_dir}"
  log_info "launch: ${cmd[*]}"
  log_info "url: ${url}"

  verify_profile_dir "$profile_dir" "Chrome"

  local existing_pid=""
  if existing_pid="$(find_kiosk_pid "$profile_dir")"; then
    log_info "Chrome ya está en ejecución (pid=${existing_pid}). Enganchando..."
    wait_for_pid_exit "$existing_pid"
    log_warn "Chrome existente terminó"
    cleanup_orphan_profile_locks "$profile_dir"
  fi

  cleanup_orphan_profile_locks "$profile_dir"

  wait_for_backend 60
  wait_for_frontend 30
  sleep 3

  local retry=0
  local -a backoffs=(2 3 5 8 10 12 15)
  local backoff_index=0
  local early_zero_without_locks=0

  while [[ $retry -lt $MAX_RETRIES ]]; do
    local start_time end_time duration
    start_time=$(date +%s)

    "${cmd[@]}" >>"$log_file" 2>&1 &
    local chrome_pid=$!

    local elapsed=0
    while [[ $elapsed -lt $SUCCESS_THRESHOLD ]]; do
      if ! kill -0 "$chrome_pid" 2>/dev/null; then
        break
      fi
      sleep 1
      elapsed=$((elapsed + 1))
    done

    local exit_code=0
    if kill -0 "$chrome_pid" 2>/dev/null; then
      log_info "Chrome arrancó correctamente (PID: $chrome_pid, viva > ${SUCCESS_THRESHOLD}s)"
      wait "$chrome_pid"
      exit_code=$?
    else
      wait "$chrome_pid"
      exit_code=$?
    fi

    end_time=$(date +%s)
    duration=$((end_time - start_time))

    local -a locks_after
    mapfile -t locks_after < <(list_profile_locks "$profile_dir") || true

    log_info "Intento $((retry + 1))/${MAX_RETRIES}: Chrome terminó en ${duration}s con código ${exit_code}"
    if [[ ${#locks_after[@]} -gt 0 ]]; then
      log_info "Locks tras salida: ${locks_after[*]}"
    else
      log_info "Locks tras salida: ninguno"
    fi

    if [[ $exit_code -eq 0 && $duration -lt $EARLY_EXIT_THRESHOLD ]]; then
      if [[ ${#locks_after[@]} -gt 0 ]]; then
        log_warn "Salida temprana con código 0 y locks presentes; limpiando perfil y reintentando"
        cleanup_orphan_profile_locks "$profile_dir"
        print_chrome_logs "$profile_dir"
      else
        if [[ $early_zero_without_locks -ge 1 ]]; then
          log_error "Chrome salió en <${EARLY_EXIT_THRESHOLD}s con código 0 sin locks por segunda vez; abortando para evitar bucle"
          print_chrome_logs "$profile_dir"
          return 10
        fi
        early_zero_without_locks=$((early_zero_without_locks + 1))
        log_warn "Chrome salió en <${EARLY_EXIT_THRESHOLD}s con código 0 sin locks; se reintentará una vez"
      fi
    elif [[ $exit_code -ne 0 ]]; then
      log_warn "Chrome terminó con error (código ${exit_code}); se reintentará si quedan intentos"
      print_chrome_logs "$profile_dir"
    else
      if [[ $duration -lt $SUCCESS_THRESHOLD ]]; then
        log_warn "Chrome salió después de ${duration}s; código ${exit_code}"
      fi
      return "$exit_code"
    fi

    retry=$((retry + 1))
    if [[ $retry -ge $MAX_RETRIES ]]; then
      log_error "Chrome falló después de ${MAX_RETRIES} intentos"
      return 1
    fi

    cleanup_orphan_profile_locks "$profile_dir"

    local sleep_time=${backoffs[$backoff_index]:-$MAX_BACKOFF}
    if [[ $sleep_time -gt $MAX_BACKOFF ]]; then
      sleep_time=$MAX_BACKOFF
    fi
    log_info "Reintentando en ${sleep_time}s (backoff)"
    sleep "$sleep_time"
    if [[ $backoff_index -lt ${#backoffs[@]}-1 ]]; then
      backoff_index=$((backoff_index + 1))
    fi
  done

  return 1
}

launch_firefox() {
  local binary="$1" url="$2" profile_dir="$3" log_file="$4"
  local -a cmd=(
    "$binary"
    --kiosk
    --new-instance
    --profile "$profile_dir"
    --no-remote
    "$url"
  )

  export MOZ_DISABLE_SAFE_MODE_DIALOG=1
  export MOZ_USE_XINPUT2=1
  export MOZ_CRASHREPORTER_DISABLE=1

  log_info "firefox_bin: ${binary}"
  log_info "profile_dir: ${profile_dir}"
  log_info "launch: ${cmd[*]}"
  log_info "url: ${url}"

  exec "${cmd[@]}" >>"$log_file" 2>&1
}

main() {
  : "${DISPLAY:=:0}"
  : "${XAUTHORITY:?XAUTHORITY must be set}"
  : "${XDG_RUNTIME_DIR:=/run/user/$(id -u)}"
  : "${DBUS_SESSION_BUS_ADDRESS:=unix:path=/run/user/$(id -u)/bus}"

  export GTK_USE_PORTAL="${GTK_USE_PORTAL:-0}"
  export GIO_USE_PORTALS="${GIO_USE_PORTALS:-0}"
  export GDK_BACKEND="${GDK_BACKEND:-x11}"

  if command -v xrandr >/dev/null 2>&1; then
    log_info "Forcing xrandr rotation to normal..."
    xrandr --output HDMI-1 --rotate normal || log_warn "xrandr rotate normal failed"
    xrandr --output HDMI-1 --mode 1920x480 || log_warn "xrandr mode 1920x480 failed"
  fi

  local raw_url target_url
  raw_url="${1:-${KIOSK_URL:-}}"
  target_url="$(resolve_url "$raw_url")"

  local state_base
  state_base="${PANTALLA_STATE_DIR:-${DEFAULT_STATE_DIR}}"

  local chromium_profile firefox_profile
  chromium_profile="${CHROMIUM_PROFILE_DIR:-${state_base}/chromium-kiosk}"
  firefox_profile="${FIREFOX_PROFILE_DIR:-${state_base}/firefox-kiosk}"

  local log_dir log_file
  log_dir="${PANTALLA_KIOSK_LOG_DIR:-${DEFAULT_LOG_DIR}}"
  log_file="${log_dir}/browser-kiosk.log"

  prepare_log_dir "$log_dir"

  verify_profile_dir "$chromium_profile" "Chrome"
  verify_profile_dir "$firefox_profile" "Firefox"

  local browser
  if browser="$(find_chromium)"; then
    launch_chromium "$browser" "$target_url" "$chromium_profile" "$log_file"
    return $?
  fi

  if browser="$(find_firefox)"; then
    launch_firefox "$browser" "$target_url" "$firefox_profile" "$log_file"
    return $?
  fi

  log_error "No se encontró un navegador compatible (Chromium/Firefox)"
  return 1
}

main "$@"

#!/usr/bin/env bash
set -euo pipefail

LOG_FILE="/var/log/pantalla/kiosk-verify.log"
DISPLAY_VALUE="${DISPLAY:-:0}"
XAUTHORITY_VALUE="${XAUTHORITY:-/var/lib/pantalla-reloj/.Xauthority}"
LOG_GLOB="/var/log/pantalla/kiosk-*.log"

run_cmd() {
  local desc cmd status
  desc="$1"
  shift
  cmd=("$@")
  {
    printf '--- %s ---\n' "$desc"
    printf 'CMD: %s\n' "${cmd[*]}"
    if "${cmd[@]}"; then
      status=0
    else
      status=$?
      printf 'exit-status=%s\n' "$status"
    fi
    printf '\n'
  }
}

mkdir -p "$(dirname "$LOG_FILE")"

{
  echo "=== $(date -Is) pantalla-kiosk-verify ==="
  echo "DISPLAY=${DISPLAY_VALUE}"
  echo "XAUTHORITY=${XAUTHORITY_VALUE}"
  echo

  run_cmd "xrandr --query" env DISPLAY="$DISPLAY_VALUE" XAUTHORITY="$XAUTHORITY_VALUE" xrandr --query
  run_cmd "xset q" env DISPLAY="$DISPLAY_VALUE" XAUTHORITY="$XAUTHORITY_VALUE" xset q
  run_cmd "wmctrl -lx" env DISPLAY="$DISPLAY_VALUE" XAUTHORITY="$XAUTHORITY_VALUE" wmctrl -lx
  run_cmd "_NET_ACTIVE_WINDOW" env DISPLAY="$DISPLAY_VALUE" XAUTHORITY="$XAUTHORITY_VALUE" xprop -root _NET_ACTIVE_WINDOW
  run_cmd "_NET_CLIENT_LIST" env DISPLAY="$DISPLAY_VALUE" XAUTHORITY="$XAUTHORITY_VALUE" xprop -root _NET_CLIENT_LIST
  run_cmd "backend health" curl -sS -o /dev/null -w '%{http_code}\n' http://127.0.0.1:8081/healthz

  shopt -s nullglob
  for logfile in $LOG_GLOB; do
    echo "--- tail ${logfile##*/} ---"
    tail -n 60 "$logfile"
    echo
  done
  shopt -u nullglob
} >"${LOG_FILE}.tmp" 2>&1

mv "${LOG_FILE}.tmp" "$LOG_FILE"

printf 'Resultados guardados en %s\n' "$LOG_FILE"
